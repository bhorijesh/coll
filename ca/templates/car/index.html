<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Car Booking</title>
    <!-- Tailwind CSS (via CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Leaflet Geocoding Plugin CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
</head>
<body class="bg-gray-900 text-white font-sans">
    <!-- Navbar -->
<!-- Navbar -->
<nav class="navbar bg-gradient-to-r from-gray-800 to-gray-900 shadow-lg">
    <div class="container mx-auto px-6 py-4 flex justify-between items-center">
        <!-- Logo -->
        <a href="{% url 'index' %}" class="text-2xl font-bold text-blue-400 hover:text-blue-500 transition duration-300">Car Booking</a>
        <!-- Nav Links -->
        <div class="hidden md:flex space-x-6 text-gray-300">
            <a href="{% url 'about_us' %}" class="hover:text-white transition duration-300">About Us</a>
            <a href="{% url 'contact_us' %}" class="hover:text-white transition duration-300">Contact</a>
            <!-- Show "Your Booking List" only if the user is authenticated -->
            {% if user.is_authenticated %}
                <a href="{% url 'your_booking_list' %}" class="hover:text-white transition duration-300">Your Booking List</a>
            {% endif %}
        </div>
        <!-- Search Bar -->
        <form method="GET" action="{% url 'car_search' %}" class="flex items-center">
            <input type="search" name="search" placeholder="Search cars..." class="px-4 py-2 bg-gray-700 text-white rounded-l-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            <button type="submit" class="px-4 py-2 bg-blue-500 text-white rounded-r-md hover:bg-blue-600 transition duration-300">Search</button>
        </form>
        <!-- Login/Logout Buttons -->
        <div class="flex space-x-4 items-center">
            {% if user.is_authenticated %}
                <!-- Display username -->
                <span class="text-gray-400">Hello, {{ user.username }}</span>
                <a href="{% url 'logout_page' %}" class="text-red-500 hover:text-red-600 transition duration-300">Logout</a>
            {% else %}
                <a href="{% url 'login' %}" class="text-green-500 hover:text-green-600 transition duration-300">Login</a>
            {% endif %}
        </div>
    </div>
</nav>

    <!-- Main Content -->
    <header class="text-center py-8">
        <h1 class="text-4xl font-bold text-white">Welcome to Car Booking</h1>
        <p class="mt-2 text-gray-400">Find your perfect ride today!</p>
    </header>

    <!-- Map Section -->
    <div id="map" class="w-full h-[500px] mx-auto mb-6 border-2 border-gray-700 rounded-lg shadow-lg"></div>
    <p class="text-center mt-4 text-gray-400">Latitude: <span id="latitude">{{ user_lat }}</span>, Longitude: <span id="longitude">{{ user_lon }}</span></p>

    <!-- Nearby Cars Section -->
    <div class="car-info mx-auto max-w-7xl mt-6 p-6 bg-gray-800 rounded-lg shadow-lg">
        <h3 class="text-2xl font-semibold text-white mb-6">Nearby Cars</h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <!-- Nearby cars will be dynamically added here -->
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Leaflet Geocoding Plugin JS -->
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
    <script>
        // Initialize the map
        const map = L.map('map').setView([0, 0], 2); // Default view (worldwide)
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);

        // Add geocoding control to the map
        const geocoder = L.Control.geocoder({
            defaultMarkGeocode: false
        }).addTo(map);

        geocoder.on('markgeocode', function(event) {
            const { latlng } = event.geocode;

            // Move the map view to the searched location
            map.setView(latlng, 15);

            // Clear any existing markers
            map.eachLayer((layer) => {
                if (layer instanceof L.Marker) {
                    map.removeLayer(layer);
                }
            });

            // Add a new marker at the searched location
            L.marker(latlng).addTo(map);

            // Simulate a manual click on the map at the searched location
            const simulatedClickEvent = {
                latlng: latlng
            };
            map.fire('click', simulatedClickEvent);
        });

        // Function to update the map with the device's location
        function updateDeviceLocation(lat, lng) {
            document.getElementById('latitude').textContent = lat.toFixed(6);
            document.getElementById('longitude').textContent = lng.toFixed(6);

            // Clear any existing markers
            map.eachLayer((layer) => {
                if (layer instanceof L.Marker) {
                    map.removeLayer(layer);
                }
            });

            // Add a new marker at the device's location
            L.marker([lat, lng]).addTo(map);
            map.setView([lat, lng], 15); // Zoom to the device's location

            // Fetch nearby cars from the server
            fetchNearbyCars(lat, lng);
        }

        // Allow manual location selection by clicking on the map
        map.on('click', function(event) {
            const { lat, lng } = event.latlng;
            updateDeviceLocation(lat, lng);
        });

        // Function to fetch nearby cars from the server
        function fetchNearbyCars(lat, lng) {
            fetch(`/nearby-cars/?latitude=${lat}&longitude=${lng}`)
                .then(response => response.json())
                .then(data => {
                    const carTable = document.querySelector('.grid');
                    carTable.innerHTML = ''; // Clear the current list
                    if (data.cars && data.cars.length > 0) {
                        // Sort cars by distance (nearest first)
                        data.cars.sort((a, b) => a.distance - b.distance);
                        data.cars.forEach(car => {
                            const carCard = document.createElement('div');
                            carCard.classList.add('bg-gray-700', 'rounded-lg', 'shadow-lg', 'overflow-hidden', 'transition', 'duration-300', 'hover:shadow-xl', 'hover:scale-105');
                            carCard.innerHTML = `
                                <img src="${car.image_url || 'https://via.placeholder.com/400'}" alt="${car.name}" class="w-full h-48 object-cover">
                                <div class="p-4">
                                    <h4 class="text-lg font-semibold text-white">${car.name}</h4>
                                    <p class="text-sm text-gray-400"><strong>Year:</strong> ${car.year}</p>
                                    <p class="text-sm text-gray-400"><strong>Fuel Type:</strong> ${car.fuel_type}</p>
                                    <p class="text-sm text-gray-400"><strong>Seating Capacity:</strong> ${car.seating_capacity} seats</p>
                                    <p class="text-sm text-gray-400"><strong>Price per Day:</strong> $${car.price_per_km}</p>
                                    <p class="text-sm text-gray-400"><strong>Availability:</strong> 
                                        ${car.is_available ? '<span class="text-green-500">Available</span>' : '<span class="text-red-500">Not Available</span>'}
                                    </p>
                                    <p class="text-sm text-gray-400"><strong>Description:</strong> ${car.description}</p>
                                    <p class="text-sm text-gray-400"><strong>Distance:</strong> ${car.distance.toFixed(2)} km</p>
                                    <div class="flex justify-between mt-4">
                                        <a href="/car/${car.id}/" class="text-blue-500 hover:text-blue-600 transition duration-300">View Details</a>
                                        <a href="/booking/?car_id=${car.id}&latitude=${lat}&longitude=${lng}" class="text-green-500 hover:text-green-600 transition duration-300">Book Now</a>
                                    </div>
                                </div>
                            `;
                            carTable.appendChild(carCard);
                        });
                    } else {
                        carTable.innerHTML = '<p class="no-cars text-center text-gray-500 col-span-full">No cars found nearby.</p>';
                    }
                })
                .catch(error => {
                    console.error('Error fetching nearby cars:', error);
                    document.querySelector('.grid').innerHTML = '<p class="no-cars text-center text-red-500 col-span-full">Error fetching cars.</p>';
                });
        }

        // Automatically fetch device location on page load
        window.onload = () => {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const { latitude, longitude } = position.coords;
                        updateDeviceLocation(latitude, longitude);
                    },
                    (error) => {
                        console.error('Error getting location:', error.message);
                        alert('Unable to retrieve your location. Using default location.');
                        // Fallback to a default location (e.g., New York)
                        updateDeviceLocation(40.7128, -74.0060);
                    }
                );
            } else {
                alert('Geolocation is not supported by your browser. Using default location.');
                // Fallback to a default location (e.g., New York)
                updateDeviceLocation(40.7128, -74.0060);
            }
        };
    </script>
</body>
</html>